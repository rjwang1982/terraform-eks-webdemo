{% extends "base.html" %}

{% block title %}EBS æ¼”ç¤º - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“¦ EBS å—å­˜å‚¨æ¼”ç¤º</h1>
    <p>æ¼”ç¤ºåº”ç”¨å¦‚ä½•è®¿é—® EBS å·è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨</p>
</div>

<div class="content">
    <!-- EBS ä¿¡æ¯ -->
    <div class="card">
        <div class="card-header">â„¹ï¸ EBS å·ä¿¡æ¯</div>
        <div class="card-body" id="ebsInfo">
            <!-- EBS ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- å†™å…¥æ•°æ® -->
    <div class="card">
        <div class="card-header">âœï¸ å†™å…¥æ•°æ®</div>
        <div class="card-body">
            <form id="writeForm" onsubmit="writeData(event)">
                <div class="form-group">
                    <label for="content">å†…å®¹</label>
                    <textarea id="content" class="form-control" rows="3" placeholder="è¾“å…¥è¦å†™å…¥çš„å†…å®¹..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">å†™å…¥åˆ° EBS</button>
            </form>
        </div>
    </div>
    
    <!-- è¯»å–æ•°æ® -->
    <div class="card">
        <div class="card-header">
            ğŸ“– å†å²è®°å½•
            <button onclick="loadLogs()" class="btn btn-secondary" style="float: right; padding: 5px 15px;">åˆ·æ–°</button>
        </div>
        <div class="card-body" id="logsContainer">
            <!-- æ—¥å¿—è®°å½•å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    // åŠ è½½ EBS ä¿¡æ¯
    async function loadEBSInfo() {
        try {
            const data = await apiRequest('/ebs/');
            displayEBSInfo(data);
        } catch (error) {
            console.error('åŠ è½½ EBS ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤º EBS ä¿¡æ¯
    function displayEBSInfo(data) {
        const container = document.getElementById('ebsInfo');
        
        if (!data.ebs_info) {
            container.innerHTML = '<p>æ— æ³•è·å– EBS ä¿¡æ¯</p>';
            return;
        }
        
        const info = data.ebs_info;
        let html = '<table class="table">';
        html += `<tr><th>æŒ‚è½½è·¯å¾„</th><td>${info.mount_path}</td></tr>`;
        html += `<tr><th>çŠ¶æ€</th><td><span class="status-badge ${info.available ? 'success' : 'error'}">${info.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}</span></td></tr>`;
        
        if (info.disk_usage) {
            const usage = info.disk_usage;
            const usagePercent = usage.usage_percent || 0;
            const statusClass = usagePercent > 80 ? 'error' : usagePercent > 60 ? 'warning' : 'success';
            
            html += `<tr><th>æ€»å®¹é‡</th><td>${formatBytes(usage.total_bytes)}</td></tr>`;
            html += `<tr><th>å·²ä½¿ç”¨</th><td>${formatBytes(usage.used_bytes)}</td></tr>`;
            html += `<tr><th>å¯ç”¨ç©ºé—´</th><td>${formatBytes(usage.available_bytes)}</td></tr>`;
            html += `<tr><th>ä½¿ç”¨ç‡</th><td><span class="status-badge ${statusClass}">${formatPercent(usagePercent)}</span></td></tr>`;
        }
        
        if (info.log_file) {
            html += `<tr><th>æ—¥å¿—æ–‡ä»¶</th><td>${info.log_file.path}</td></tr>`;
            html += `<tr><th>æ—¥å¿—å¤§å°</th><td>${formatBytes(info.log_file.size_bytes)}</td></tr>`;
            html += `<tr><th>æ—¥å¿—æ¡æ•°</th><td>${info.log_file.line_count}</td></tr>`;
        }
        
        html += '</table>';
        
        if (data.current_pod) {
            html += '<h4>å½“å‰ Pod ä¿¡æ¯</h4>';
            html += '<table class="table">';
            html += `<tr><th>Pod åç§°</th><td>${data.current_pod.name}</td></tr>`;
            html += `<tr><th>å‘½åç©ºé—´</th><td>${data.current_pod.namespace}</td></tr>`;
            html += `<tr><th>èŠ‚ç‚¹</th><td>${data.current_pod.node}</td></tr>`;
            html += '</table>';
        }
        
        container.innerHTML = html;
        
        // åŠ è½½æ—¥å¿—
        if (data.recent_logs) {
            displayLogs(data.recent_logs);
        }
    }
    
    // å†™å…¥æ•°æ®
    async function writeData(event) {
        event.preventDefault();
        
        const content = document.getElementById('content').value;
        
        try {
            const data = await apiRequest('/ebs/write', {
                method: 'POST',
                body: JSON.stringify({ content })
            });
            
            showSuccess('æ•°æ®å†™å…¥æˆåŠŸï¼');
            document.getElementById('content').value = '';
            
            // é‡æ–°åŠ è½½æ—¥å¿—
            loadLogs();
        } catch (error) {
            console.error('å†™å…¥æ•°æ®å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½æ—¥å¿—
    async function loadLogs() {
        try {
            const data = await apiRequest('/ebs/read?limit=50');
            displayLogs(data.logs);
        } catch (error) {
            console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºæ—¥å¿—
    function displayLogs(logs) {
        const container = document.getElementById('logsContainer');
        
        if (!logs || logs.length === 0) {
            container.innerHTML = '<p>æš‚æ— è®°å½•</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>æ—¶é—´</th><th>ç±»å‹</th><th>Pod</th><th>å†…å®¹</th></tr></thead>';
        html += '<tbody>';
        
        logs.forEach(log => {
            html += '<tr>';
            html += `<td>${formatTimestamp(log.timestamp)}</td>`;
            html += `<td><span class="status-badge info">${log.type || 'N/A'}</span></td>`;
            html += `<td>${log.pod_name || 'N/A'}</td>`;
            html += `<td>${log.content || log.request_path || 'N/A'}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', () => {
        loadEBSInfo();
    });
</script>
{% endblock %}
