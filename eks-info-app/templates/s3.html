{% extends "base.html" %}

{% block title %}S3 æ¼”ç¤º - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>â˜ï¸ S3 å¯¹è±¡å­˜å‚¨æ¼”ç¤º</h1>
    <p>æ¼”ç¤ºåº”ç”¨å¦‚ä½•é€šè¿‡ IRSA è®¿é—® S3 å¯¹è±¡å­˜å‚¨</p>
</div>

<div class="content">
    <!-- S3 ä¿¡æ¯ -->
    <div class="card">
        <div class="card-header">â„¹ï¸ S3 å­˜å‚¨æ¡¶ä¿¡æ¯</div>
        <div class="card-body" id="s3Info">
            <!-- S3 ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- ä¸Šä¼ å¯¹è±¡ -->
    <div class="card">
        <div class="card-header">â¬†ï¸ ä¸Šä¼ å¯¹è±¡</div>
        <div class="card-body">
            <form id="uploadForm" onsubmit="uploadObject(event)">
                <div class="form-group">
                    <label for="objectKey">å¯¹è±¡é”®å</label>
                    <input type="text" id="objectKey" class="form-control" placeholder="ä¾‹å¦‚: data/test.txt" required>
                </div>
                <div class="form-group">
                    <label for="content">å†…å®¹</label>
                    <textarea id="content" class="form-control" rows="3" placeholder="è¾“å…¥è¦ä¸Šä¼ çš„å†…å®¹..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ åˆ° S3</button>
            </form>
        </div>
    </div>
    
    <!-- å¯¹è±¡åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">
            ğŸ“¦ å¯¹è±¡åˆ—è¡¨
            <button onclick="loadObjects()" class="btn btn-secondary" style="float: right; padding: 5px 15px;">åˆ·æ–°</button>
        </div>
        <div class="card-body" id="objectsContainer">
            <!-- å¯¹è±¡åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    // åŠ è½½ S3 ä¿¡æ¯
    async function loadS3Info() {
        try {
            const data = await apiRequest('/s3/');
            displayS3Info(data);
        } catch (error) {
            console.error('åŠ è½½ S3 ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤º S3 ä¿¡æ¯
    function displayS3Info(data) {
        const container = document.getElementById('s3Info');
        
        if (!data.s3_info) {
            container.innerHTML = '<p>æ— æ³•è·å– S3 ä¿¡æ¯</p>';
            return;
        }
        
        const info = data.s3_info;
        let html = '<table class="table">';
        html += `<tr><th>å­˜å‚¨æ¡¶åç§°</th><td>${info.bucket_name}</td></tr>`;
        html += `<tr><th>åŒºåŸŸ</th><td>${info.region}</td></tr>`;
        html += `<tr><th>çŠ¶æ€</th><td><span class="status-badge ${info.available ? 'success' : 'error'}">${info.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}</span></td></tr>`;
        html += `<tr><th>è®¿é—®æ–¹å¼</th><td>IRSA (IAM Roles for Service Accounts)</td></tr>`;
        
        if (info.bucket_info) {
            html += `<tr><th>å¯¹è±¡æ•°é‡</th><td>${info.bucket_info.object_count || 0}</td></tr>`;
            html += `<tr><th>æ€»å¤§å°</th><td>${formatBytes(info.bucket_info.total_size_bytes || 0)}</td></tr>`;
        }
        
        html += '</table>';
        
        if (data.irsa_info) {
            html += '<h4>IRSA é…ç½®</h4>';
            html += '<table class="table">';
            html += `<tr><th>æœåŠ¡è´¦å·</th><td>${data.irsa_info.service_account}</td></tr>`;
            html += `<tr><th>IAM è§’è‰² ARN</th><td>${data.irsa_info.role_arn || 'N/A'}</td></tr>`;
            html += '</table>';
            html += '<p class="status-badge info">ğŸ’¡ åº”ç”¨é€šè¿‡ IRSA è‡ªåŠ¨è·å–ä¸´æ—¶å‡­è¯ï¼Œæ— éœ€ç¡¬ç¼–ç å¯†é’¥</p>';
        }
        
        if (data.current_pod) {
            html += '<h4>å½“å‰ Pod ä¿¡æ¯</h4>';
            html += '<table class="table">';
            html += `<tr><th>Pod åç§°</th><td>${data.current_pod.name}</td></tr>`;
            html += `<tr><th>å‘½åç©ºé—´</th><td>${data.current_pod.namespace}</td></tr>`;
            html += `<tr><th>èŠ‚ç‚¹</th><td>${data.current_pod.node}</td></tr>`;
            html += '</table>';
        }
        
        container.innerHTML = html;
        
        // åŠ è½½å¯¹è±¡åˆ—è¡¨
        if (data.objects) {
            displayObjects(data.objects);
        }
    }
    
    // ä¸Šä¼ å¯¹è±¡
    async function uploadObject(event) {
        event.preventDefault();
        
        const objectKey = document.getElementById('objectKey').value;
        const content = document.getElementById('content').value;
        
        try {
            const data = await apiRequest('/s3/upload', {
                method: 'POST',
                body: JSON.stringify({ 
                    key: objectKey,
                    content: content
                })
            });
            
            showSuccess('å¯¹è±¡ä¸Šä¼ æˆåŠŸï¼');
            document.getElementById('objectKey').value = '';
            document.getElementById('content').value = '';
            
            // é‡æ–°åŠ è½½å¯¹è±¡åˆ—è¡¨
            loadObjects();
        } catch (error) {
            console.error('ä¸Šä¼ å¯¹è±¡å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½å¯¹è±¡åˆ—è¡¨
    async function loadObjects() {
        try {
            const data = await apiRequest('/s3/list');
            displayObjects(data.objects);
        } catch (error) {
            console.error('åŠ è½½å¯¹è±¡åˆ—è¡¨å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºå¯¹è±¡åˆ—è¡¨
    function displayObjects(objects) {
        const container = document.getElementById('objectsContainer');
        
        if (!objects || objects.length === 0) {
            container.innerHTML = '<p>æš‚æ— å¯¹è±¡</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>å¯¹è±¡é”®å</th><th>å¤§å°</th><th>æœ€åä¿®æ”¹æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>';
        html += '<tbody>';
        
        objects.forEach(obj => {
            html += '<tr>';
            html += `<td>${obj.key}</td>`;
            html += `<td>${formatBytes(obj.size_bytes)}</td>`;
            html += `<td>${formatTimestamp(obj.last_modified)}</td>`;
            html += `<td>
                <button onclick="downloadObject('${obj.key}')" class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;">ä¸‹è½½</button>
                <button onclick="deleteObject('${obj.key}')" class="btn btn-danger" style="padding: 5px 10px;">åˆ é™¤</button>
            </td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // ä¸‹è½½å¯¹è±¡
    async function downloadObject(key) {
        try {
            const data = await apiRequest(`/s3/download/${encodeURIComponent(key)}`);
            
            if (data.content) {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([data.content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = key.split('/').pop();
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('å¯¹è±¡ä¸‹è½½æˆåŠŸï¼');
            }
        } catch (error) {
            console.error('ä¸‹è½½å¯¹è±¡å¤±è´¥:', error);
        }
    }
    
    // åˆ é™¤å¯¹è±¡
    async function deleteObject(key) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å¯¹è±¡ "${key}" å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            await apiRequest(`/s3/delete/${encodeURIComponent(key)}`, {
                method: 'DELETE'
            });
            
            showSuccess('å¯¹è±¡åˆ é™¤æˆåŠŸï¼');
            loadObjects();
        } catch (error) {
            console.error('åˆ é™¤å¯¹è±¡å¤±è´¥:', error);
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', () => {
        loadS3Info();
    });
</script>
{% endblock %}
