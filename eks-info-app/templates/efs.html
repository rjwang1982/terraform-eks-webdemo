{% extends "base.html" %}

{% block title %}EFS æ¼”ç¤º - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“ EFS å…±äº«æ–‡ä»¶ç³»ç»Ÿæ¼”ç¤º</h1>
    <p>æ¼”ç¤ºå¤šä¸ª Pod å¦‚ä½•å…±äº«è®¿é—® EFS æ–‡ä»¶ç³»ç»Ÿ</p>
</div>

<div class="content">
    <!-- EFS ä¿¡æ¯ -->
    <div class="card">
        <div class="card-header">â„¹ï¸ EFS æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</div>
        <div class="card-body" id="efsInfo">
            <!-- EFS ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- å†™å…¥æ–‡ä»¶ -->
    <div class="card">
        <div class="card-header">âœï¸ å†™å…¥æ–‡ä»¶</div>
        <div class="card-body">
            <form id="writeForm" onsubmit="writeFile(event)">
                <div class="form-group">
                    <label for="content">å†…å®¹</label>
                    <textarea id="content" class="form-control" rows="3" placeholder="è¾“å…¥è¦å†™å…¥çš„å†…å®¹..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">å†™å…¥åˆ° EFS</button>
            </form>
        </div>
    </div>
    
    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">
            ğŸ“‚ å…±äº«æ–‡ä»¶åˆ—è¡¨
            <button onclick="loadFiles()" class="btn btn-secondary" style="float: right; padding: 5px 15px;">åˆ·æ–°</button>
        </div>
        <div class="card-body" id="filesContainer">
            <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    // åŠ è½½ EFS ä¿¡æ¯
    async function loadEFSInfo() {
        try {
            const data = await apiRequest('/efs/');
            displayEFSInfo(data);
        } catch (error) {
            console.error('åŠ è½½ EFS ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤º EFS ä¿¡æ¯
    function displayEFSInfo(data) {
        const container = document.getElementById('efsInfo');
        
        if (!data.efs_info) {
            container.innerHTML = '<p>æ— æ³•è·å– EFS ä¿¡æ¯</p>';
            return;
        }
        
        const info = data.efs_info;
        let html = '<table class="table">';
        html += `<tr><th>æŒ‚è½½è·¯å¾„</th><td>${info.mount_path}</td></tr>`;
        html += `<tr><th>çŠ¶æ€</th><td><span class="status-badge ${info.available ? 'success' : 'error'}">${info.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}</span></td></tr>`;
        
        if (info.filesystem_usage) {
            const usage = info.filesystem_usage;
            html += `<tr><th>æ€»å®¹é‡</th><td>${formatBytes(usage.total_bytes)}</td></tr>`;
            html += `<tr><th>å·²ä½¿ç”¨</th><td>${formatBytes(usage.used_bytes)}</td></tr>`;
            html += `<tr><th>å¯ç”¨ç©ºé—´</th><td>${formatBytes(usage.available_bytes)}</td></tr>`;
            html += `<tr><th>ä½¿ç”¨ç‡</th><td>${formatPercent(usage.usage_percent)}</td></tr>`;
        }
        
        html += '</table>';
        
        if (data.current_pod) {
            html += '<h4>å½“å‰å¤„ç†è¯·æ±‚çš„ Pod</h4>';
            html += '<table class="table">';
            html += `<tr><th>Pod åç§°</th><td>${data.current_pod.name}</td></tr>`;
            html += `<tr><th>å‘½åç©ºé—´</th><td>${data.current_pod.namespace}</td></tr>`;
            html += `<tr><th>èŠ‚ç‚¹</th><td>${data.current_pod.node}</td></tr>`;
            html += '</table>';
            html += '<p class="status-badge info">ğŸ’¡ åˆ·æ–°é¡µé¢å¯èƒ½ä¼šçœ‹åˆ°ä¸åŒçš„ Pod å¤„ç†è¯·æ±‚ï¼Œä½†éƒ½èƒ½è®¿é—®ç›¸åŒçš„ EFS æ•°æ®</p>';
        }
        
        container.innerHTML = html;
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        if (data.files) {
            displayFiles(data.files);
        }
    }
    
    // å†™å…¥æ–‡ä»¶
    async function writeFile(event) {
        event.preventDefault();
        
        const content = document.getElementById('content').value;
        
        try {
            const data = await apiRequest('/efs/write', {
                method: 'POST',
                body: JSON.stringify({ content })
            });
            
            showSuccess('æ–‡ä»¶å†™å…¥æˆåŠŸï¼');
            document.getElementById('content').value = '';
            
            // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            loadFiles();
        } catch (error) {
            console.error('å†™å…¥æ–‡ä»¶å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    async function loadFiles() {
        try {
            const data = await apiRequest('/efs/list');
            displayFiles(data.files);
        } catch (error) {
            console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
    function displayFiles(files) {
        const container = document.getElementById('filesContainer');
        
        if (!files || files.length === 0) {
            container.innerHTML = '<p>æš‚æ— æ–‡ä»¶</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>æ–‡ä»¶å</th><th>åˆ›å»ºæ—¶é—´</th><th>åˆ›å»ºè€… Pod</th><th>å¤§å°</th><th>æ“ä½œ</th></tr></thead>';
        html += '<tbody>';
        
        files.forEach(file => {
            html += '<tr>';
            html += `<td>${file.filename}</td>`;
            html += `<td>${formatTimestamp(file.created_at)}</td>`;
            html += `<td>${file.created_by_pod}</td>`;
            html += `<td>${formatBytes(file.size_bytes)}</td>`;
            html += `<td>
                <button onclick="readFile('${file.filename}')" class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;">æŸ¥çœ‹</button>
                <button onclick="deleteFile('${file.filename}')" class="btn btn-danger" style="padding: 5px 10px;">åˆ é™¤</button>
            </td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // è¯»å–æ–‡ä»¶
    async function readFile(filename) {
        try {
            const data = await apiRequest(`/efs/read/${encodeURIComponent(filename)}`);
            
            if (data.content) {
                alert(`æ–‡ä»¶å†…å®¹:\n\n${data.content}\n\nåˆ›å»ºè€…: ${data.metadata.created_by_pod}\nåˆ›å»ºæ—¶é—´: ${formatTimestamp(data.metadata.created_at)}`);
            }
        } catch (error) {
            console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
        }
    }
    
    // åˆ é™¤æ–‡ä»¶
    async function deleteFile(filename) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            await apiRequest(`/efs/delete/${encodeURIComponent(filename)}`, {
                method: 'DELETE'
            });
            
            showSuccess('æ–‡ä»¶åˆ é™¤æˆåŠŸï¼');
            loadFiles();
        } catch (error) {
            console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', () => {
        loadEFSInfo();
    });
</script>
{% endblock %}
