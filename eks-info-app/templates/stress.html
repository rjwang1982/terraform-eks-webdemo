{% extends "base.html" %}

{% block title %}å‹åŠ›æµ‹è¯• - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>âš¡ å‹åŠ›æµ‹è¯•</h1>
    <p>æ‰§è¡Œ CPU å’Œå†…å­˜å‹åŠ›æµ‹è¯•ï¼Œè§‚å¯Ÿ HPA è‡ªåŠ¨æ‰©å±•</p>
</div>

<div class="content">
    <!-- å½“å‰èµ„æºä½¿ç”¨æƒ…å†µ -->
    <div class="card">
        <div class="card-header">
            ğŸ“Š å½“å‰èµ„æºä½¿ç”¨æƒ…å†µ
            <button onclick="loadCurrentUsage()" class="btn btn-secondary" style="float: right; padding: 5px 15px;">åˆ·æ–°</button>
        </div>
        <div class="card-body" id="currentUsage">
            <!-- èµ„æºä½¿ç”¨æƒ…å†µå°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- CPU å‹åŠ›æµ‹è¯• -->
    <div class="card">
        <div class="card-header">ğŸ”¥ CPU å‹åŠ›æµ‹è¯•</div>
        <div class="card-body">
            <form id="cpuStressForm" onsubmit="startCPUStress(event)">
                <div class="form-group">
                    <label for="cpuDuration">æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="cpuDuration" class="form-control" value="60" min="10" max="300" required>
                </div>
                <div class="form-group">
                    <label for="cpuIntensity">å¼ºåº¦çº§åˆ«ï¼ˆ1-10ï¼‰</label>
                    <input type="number" id="cpuIntensity" class="form-control" value="5" min="1" max="10" required>
                </div>
                <button type="submit" class="btn btn-danger" id="cpuStressBtn">å¯åŠ¨ CPU å‹åŠ›æµ‹è¯•</button>
                <button type="button" class="btn btn-secondary" onclick="stopStress('cpu')" style="margin-left: 10px;">åœæ­¢æµ‹è¯•</button>
            </form>
            <div id="cpuStressStatus" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <!-- å†…å­˜å‹åŠ›æµ‹è¯• -->
    <div class="card">
        <div class="card-header">ğŸ’¾ å†…å­˜å‹åŠ›æµ‹è¯•</div>
        <div class="card-body">
            <form id="memoryStressForm" onsubmit="startMemoryStress(event)">
                <div class="form-group">
                    <label for="memoryDuration">æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="memoryDuration" class="form-control" value="60" min="10" max="300" required>
                </div>
                <div class="form-group">
                    <label for="memoryTarget">ç›®æ ‡å†…å­˜ï¼ˆMBï¼‰</label>
                    <input type="number" id="memoryTarget" class="form-control" value="256" min="50" max="1024" required>
                </div>
                <button type="submit" class="btn btn-danger" id="memoryStressBtn">å¯åŠ¨å†…å­˜å‹åŠ›æµ‹è¯•</button>
                <button type="button" class="btn btn-secondary" onclick="stopStress('memory')" style="margin-left: 10px;">åœæ­¢æµ‹è¯•</button>
            </form>
            <div id="memoryStressStatus" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <!-- HPA çŠ¶æ€ -->
    <div class="card">
        <div class="card-header">
            ğŸ“ˆ HPA çŠ¶æ€
            <button onclick="loadHPAStatus()" class="btn btn-secondary" style="float: right; padding: 5px 15px;">åˆ·æ–°</button>
        </div>
        <div class="card-body" id="hpaStatus">
            <!-- HPA çŠ¶æ€å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    let statusInterval = null;
    
    // åŠ è½½å½“å‰èµ„æºä½¿ç”¨æƒ…å†µ
    async function loadCurrentUsage() {
        try {
            const data = await apiRequest('/stress/usage');
            displayCurrentUsage(data);
        } catch (error) {
            console.error('åŠ è½½èµ„æºä½¿ç”¨æƒ…å†µå¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºå½“å‰èµ„æºä½¿ç”¨æƒ…å†µ
    function displayCurrentUsage(data) {
        const container = document.getElementById('currentUsage');
        
        let html = '<table class="table">';
        
        if (data.cpu_usage !== undefined) {
            const cpuClass = data.cpu_usage > 70 ? 'error' : data.cpu_usage > 50 ? 'warning' : 'success';
            html += `<tr><th>CPU ä½¿ç”¨ç‡</th><td><span class="status-badge ${cpuClass}">${data.cpu_usage.toFixed(2)}%</span></td></tr>`;
        }
        
        if (data.memory_usage) {
            const memPercent = (data.memory_usage.used_mb / data.memory_usage.total_mb * 100).toFixed(2);
            const memClass = memPercent > 80 ? 'error' : memPercent > 60 ? 'warning' : 'success';
            html += `<tr><th>å†…å­˜ä½¿ç”¨</th><td>${data.memory_usage.used_mb.toFixed(0)} MB / ${data.memory_usage.total_mb.toFixed(0)} MB <span class="status-badge ${memClass}">${memPercent}%</span></td></tr>`;
        }
        
        if (data.pod_info) {
            html += `<tr><th>å½“å‰ Pod</th><td>${data.pod_info.name}</td></tr>`;
        }
        
        html += '</table>';
        container.innerHTML = html;
    }
    
    // å¯åŠ¨ CPU å‹åŠ›æµ‹è¯•
    async function startCPUStress(event) {
        event.preventDefault();
        
        const duration = parseInt(document.getElementById('cpuDuration').value);
        const intensity = parseInt(document.getElementById('cpuIntensity').value);
        
        try {
            const data = await apiRequest('/stress/cpu', {
                method: 'POST',
                body: JSON.stringify({ duration, intensity })
            });
            
            showSuccess('CPU å‹åŠ›æµ‹è¯•å·²å¯åŠ¨ï¼');
            
            // å¼€å§‹ç›‘æ§çŠ¶æ€
            startStatusMonitoring('cpu', data.test_id);
        } catch (error) {
            console.error('å¯åŠ¨ CPU å‹åŠ›æµ‹è¯•å¤±è´¥:', error);
        }
    }
    
    // å¯åŠ¨å†…å­˜å‹åŠ›æµ‹è¯•
    async function startMemoryStress(event) {
        event.preventDefault();
        
        const duration = parseInt(document.getElementById('memoryDuration').value);
        const targetMB = parseInt(document.getElementById('memoryTarget').value);
        
        try {
            const data = await apiRequest('/stress/memory', {
                method: 'POST',
                body: JSON.stringify({ duration, target_mb: targetMB })
            });
            
            showSuccess('å†…å­˜å‹åŠ›æµ‹è¯•å·²å¯åŠ¨ï¼');
            
            // å¼€å§‹ç›‘æ§çŠ¶æ€
            startStatusMonitoring('memory', data.test_id);
        } catch (error) {
            console.error('å¯åŠ¨å†…å­˜å‹åŠ›æµ‹è¯•å¤±è´¥:', error);
        }
    }
    
    // åœæ­¢å‹åŠ›æµ‹è¯•
    async function stopStress(type) {
        try {
            await apiRequest(`/stress/stop/${type}`, {
                method: 'POST'
            });
            
            showSuccess('å‹åŠ›æµ‹è¯•å·²åœæ­¢ï¼');
            stopStatusMonitoring();
            loadCurrentUsage();
        } catch (error) {
            console.error('åœæ­¢å‹åŠ›æµ‹è¯•å¤±è´¥:', error);
        }
    }
    
    // å¼€å§‹ç›‘æ§çŠ¶æ€
    function startStatusMonitoring(type, testId) {
        stopStatusMonitoring();
        
        statusInterval = setInterval(async () => {
            try {
                const data = await apiRequest(`/stress/status/${testId}`);
                displayStressStatus(type, data);
                
                // åŒæ—¶æ›´æ–°èµ„æºä½¿ç”¨æƒ…å†µ
                loadCurrentUsage();
                
                // å¦‚æœæµ‹è¯•å®Œæˆï¼Œåœæ­¢ç›‘æ§
                if (data.status === 'completed' || data.status === 'stopped') {
                    stopStatusMonitoring();
                }
            } catch (error) {
                console.error('è·å–å‹åŠ›æµ‹è¯•çŠ¶æ€å¤±è´¥:', error);
                stopStatusMonitoring();
            }
        }, 2000);
    }
    
    // åœæ­¢ç›‘æ§çŠ¶æ€
    function stopStatusMonitoring() {
        if (statusInterval) {
            clearInterval(statusInterval);
            statusInterval = null;
        }
    }
    
    // æ˜¾ç¤ºå‹åŠ›æµ‹è¯•çŠ¶æ€
    function displayStressStatus(type, data) {
        const containerId = type === 'cpu' ? 'cpuStressStatus' : 'memoryStressStatus';
        const container = document.getElementById(containerId);
        
        let html = '<div style="padding: 15px; background-color: #f8f9fa; border-radius: 4px;">';
        html += `<p><strong>çŠ¶æ€:</strong> <span class="status-badge ${getStatusClass(data.status)}">${data.status}</span></p>`;
        
        if (data.progress !== undefined) {
            html += `<p><strong>è¿›åº¦:</strong> ${data.progress.toFixed(1)}%</p>`;
            html += `<div style="background-color: #ddd; border-radius: 4px; height: 20px; overflow: hidden;">`;
            html += `<div style="background-color: #ff9900; height: 100%; width: ${data.progress}%; transition: width 0.3s;"></div>`;
            html += `</div>`;
        }
        
        if (data.elapsed_seconds !== undefined) {
            html += `<p><strong>å·²è¿è¡Œ:</strong> ${data.elapsed_seconds} ç§’</p>`;
        }
        
        if (data.remaining_seconds !== undefined) {
            html += `<p><strong>å‰©ä½™:</strong> ${data.remaining_seconds} ç§’</p>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // åŠ è½½ HPA çŠ¶æ€
    async function loadHPAStatus() {
        try {
            const data = await apiRequest('/stress/hpa');
            displayHPAStatus(data);
        } catch (error) {
            console.error('åŠ è½½ HPA çŠ¶æ€å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤º HPA çŠ¶æ€
    function displayHPAStatus(data) {
        const container = document.getElementById('hpaStatus');
        
        if (!data.hpa) {
            container.innerHTML = '<p>æœªæ‰¾åˆ° HPA é…ç½®</p>';
            return;
        }
        
        const hpa = data.hpa;
        let html = '<table class="table">';
        html += `<tr><th>HPA åç§°</th><td>${hpa.name || 'N/A'}</td></tr>`;
        html += `<tr><th>å½“å‰å‰¯æœ¬æ•°</th><td><span class="status-badge info">${hpa.current_replicas || 0}</span></td></tr>`;
        html += `<tr><th>æœŸæœ›å‰¯æœ¬æ•°</th><td><span class="status-badge success">${hpa.desired_replicas || 0}</span></td></tr>`;
        html += `<tr><th>æœ€å°å‰¯æœ¬æ•°</th><td>${hpa.min_replicas || 0}</td></tr>`;
        html += `<tr><th>æœ€å¤§å‰¯æœ¬æ•°</th><td>${hpa.max_replicas || 0}</td></tr>`;
        
        if (hpa.current_cpu_utilization !== undefined) {
            const cpuClass = hpa.current_cpu_utilization > 70 ? 'error' : hpa.current_cpu_utilization > 50 ? 'warning' : 'success';
            html += `<tr><th>å½“å‰ CPU ä½¿ç”¨ç‡</th><td><span class="status-badge ${cpuClass}">${hpa.current_cpu_utilization}%</span></td></tr>`;
        }
        
        if (hpa.target_cpu_utilization !== undefined) {
            html += `<tr><th>ç›®æ ‡ CPU ä½¿ç”¨ç‡</th><td>${hpa.target_cpu_utilization}%</td></tr>`;
        }
        
        html += '</table>';
        container.innerHTML = html;
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', () => {
        loadCurrentUsage();
        loadHPAStatus();
        
        // æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°èµ„æºä½¿ç”¨æƒ…å†µ
        setInterval(loadCurrentUsage, 5000);
    });
    
    // é¡µé¢å¸è½½æ—¶åœæ­¢ç›‘æ§
    window.addEventListener('beforeunload', stopStatusMonitoring);
</script>
{% endblock %}
