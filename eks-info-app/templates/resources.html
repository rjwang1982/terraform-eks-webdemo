{% extends "base.html" %}

{% block title %}Kubernetes èµ„æº - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>â˜¸ï¸ Kubernetes èµ„æºä¿¡æ¯</h1>
    <p>æŸ¥çœ‹é›†ç¾¤èµ„æºä½¿ç”¨æƒ…å†µ</p>
    <button onclick="loadAllResources()" class="btn btn-primary" style="margin-top: 10px;">åˆ·æ–°</button>
</div>

<div class="content" id="resourcesInfo">
    <!-- èµ„æºä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ è½½ -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    // åŠ è½½æ‰€æœ‰èµ„æºä¿¡æ¯
    async function loadAllResources() {
        try {
            const data = await apiRequest('/resources/');
            displayResourcesInfo(data);
        } catch (error) {
            console.error('åŠ è½½èµ„æºä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºèµ„æºä¿¡æ¯
    function displayResourcesInfo(data) {
        const container = document.getElementById('resourcesInfo');
        let html = '';
        
        // Pods ä¿¡æ¯
        if (data.pods && data.pods.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">ğŸ”· Pods (${data.pods.length})</div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>èŠ‚ç‚¹</th>
                                    <th>IP</th>
                                    <th>é‡å¯æ¬¡æ•°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.pods.forEach(pod => {
                html += `
                    <tr>
                        <td>${pod.name}</td>
                        <td><span class="status-badge ${getStatusClass(pod.status)}">${pod.status}</span></td>
                        <td>${pod.node_name || 'N/A'}</td>
                        <td>${pod.pod_ip || 'N/A'}</td>
                        <td>${pod.restart_count || 0}</td>
                        <td>${formatTimestamp(pod.created_at)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Services ä¿¡æ¯
        if (data.services && data.services.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">ğŸ”Œ Services (${data.services.length})</div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>Cluster IP</th>
                                    <th>ç«¯å£</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.services.forEach(svc => {
                const ports = svc.ports ? svc.ports.map(p => `${p.port}:${p.target_port}/${p.protocol}`).join(', ') : 'N/A';
                html += `
                    <tr>
                        <td>${svc.name}</td>
                        <td><span class="status-badge info">${svc.type}</span></td>
                        <td>${svc.cluster_ip || 'N/A'}</td>
                        <td>${ports}</td>
                        <td>${formatTimestamp(svc.created_at)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Deployments ä¿¡æ¯
        if (data.deployments && data.deployments.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">ğŸš€ Deployments (${data.deployments.length})</div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>å‰¯æœ¬æ•°</th>
                                    <th>å¯ç”¨å‰¯æœ¬</th>
                                    <th>é•œåƒ</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.deployments.forEach(deploy => {
                const replicaStatus = deploy.available_replicas === deploy.replicas ? 'success' : 'warning';
                html += `
                    <tr>
                        <td>${deploy.name}</td>
                        <td>${deploy.replicas || 0}</td>
                        <td><span class="status-badge ${replicaStatus}">${deploy.available_replicas || 0}</span></td>
                        <td>${deploy.image || 'N/A'}</td>
                        <td>${formatTimestamp(deploy.created_at)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Nodes ä¿¡æ¯
        if (data.nodes && data.nodes.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">ğŸ–¥ï¸ Nodes (${data.nodes.length})</div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>è§’è‰²</th>
                                    <th>CPU</th>
                                    <th>å†…å­˜</th>
                                    <th>Pods</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.nodes.forEach(node => {
                html += `
                    <tr>
                        <td>${node.name}</td>
                        <td><span class="status-badge ${getStatusClass(node.status)}">${node.status}</span></td>
                        <td>${node.role || 'worker'}</td>
                        <td>${node.cpu_capacity || 'N/A'}</td>
                        <td>${node.memory_capacity || 'N/A'}</td>
                        <td>${node.pod_count || 0} / ${node.pod_capacity || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // PVCs ä¿¡æ¯
        if (data.pvcs && data.pvcs.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">ğŸ’¾ Persistent Volume Claims (${data.pvcs.length})</div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å®¹é‡</th>
                                    <th>è®¿é—®æ¨¡å¼</th>
                                    <th>å­˜å‚¨ç±»</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.pvcs.forEach(pvc => {
                html += `
                    <tr>
                        <td>${pvc.name}</td>
                        <td><span class="status-badge ${getStatusClass(pvc.status)}">${pvc.status}</span></td>
                        <td>${pvc.capacity || 'N/A'}</td>
                        <td>${pvc.access_modes ? pvc.access_modes.join(', ') : 'N/A'}</td>
                        <td>${pvc.storage_class || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', loadAllResources);
</script>
{% endblock %}
