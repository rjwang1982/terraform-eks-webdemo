{% extends "base.html" %}

{% block title %}æ‰©å±•ç›‘æ§ - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“ˆ æ‰©å±•ç›‘æ§</h1>
    <p>ç›‘æ§ Pod å’ŒèŠ‚ç‚¹çš„è‡ªåŠ¨æ‰©å±•æƒ…å†µ</p>
    <button onclick="loadAllScalingInfo()" class="btn btn-primary" style="margin-top: 10px;">åˆ·æ–°</button>
</div>

<div class="content">
    <!-- é›†ç¾¤æ¦‚è§ˆ -->
    <div class="card">
        <div class="card-header">ğŸ¢ é›†ç¾¤æ¦‚è§ˆ</div>
        <div class="card-body" id="clusterOverview">
            <!-- é›†ç¾¤æ¦‚è§ˆå°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- èŠ‚ç‚¹åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">ğŸ–¥ï¸ èŠ‚ç‚¹åˆ—è¡¨</div>
        <div class="card-body" id="nodesList">
            <!-- èŠ‚ç‚¹åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- Pod åˆ†å¸ƒ -->
    <div class="card">
        <div class="card-header">ğŸ”· Pod åˆ†å¸ƒ</div>
        <div class="card-body" id="podDistribution">
            <!-- Pod åˆ†å¸ƒå°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- Pending Pods -->
    <div class="card">
        <div class="card-header">â³ Pending Pods</div>
        <div class="card-body" id="pendingPods">
            <!-- Pending Pods å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- HPA çŠ¶æ€ -->
    <div class="card">
        <div class="card-header">âš–ï¸ HPA çŠ¶æ€</div>
        <div class="card-body" id="hpaStatus">
            <!-- HPA çŠ¶æ€å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- æ‰©å±•å†å² -->
    <div class="card">
        <div class="card-header">
            ğŸ“Š æ‰©å±•å†å²
            <a href="/scaling/history" class="btn btn-secondary" style="float: right; padding: 5px 15px;">æŸ¥çœ‹è¯¦ç»†å†å²</a>
        </div>
        <div class="card-body" id="scalingHistory">
            <!-- æ‰©å±•å†å²å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    // åŠ è½½æ‰€æœ‰æ‰©å±•ä¿¡æ¯
    async function loadAllScalingInfo() {
        try {
            const data = await apiRequest('/scaling/');
            displayScalingInfo(data);
        } catch (error) {
            console.error('åŠ è½½æ‰©å±•ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºæ‰©å±•ä¿¡æ¯
    function displayScalingInfo(data) {
        // æ˜¾ç¤ºé›†ç¾¤æ¦‚è§ˆ
        if (data.cluster_overview) {
            displayClusterOverview(data.cluster_overview);
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹åˆ—è¡¨
        if (data.nodes) {
            displayNodesList(data.nodes);
        }
        
        // æ˜¾ç¤º Pod åˆ†å¸ƒ
        if (data.pod_distribution) {
            displayPodDistribution(data.pod_distribution);
        }
        
        // æ˜¾ç¤º Pending Pods
        if (data.pending_pods !== undefined) {
            displayPendingPods(data.pending_pods);
        }
        
        // æ˜¾ç¤º HPA çŠ¶æ€
        if (data.hpa_status) {
            displayHPAStatus(data.hpa_status);
        }
        
        // æ˜¾ç¤ºæ‰©å±•å†å²
        if (data.recent_events) {
            displayScalingHistory(data.recent_events);
        }
    }
    
    // æ˜¾ç¤ºé›†ç¾¤æ¦‚è§ˆ
    function displayClusterOverview(overview) {
        const container = document.getElementById('clusterOverview');
        
        let html = '<table class="table">';
        html += `<tr><th>æ€»èŠ‚ç‚¹æ•°</th><td><span class="status-badge info">${overview.total_nodes || 0}</span></td></tr>`;
        html += `<tr><th>å°±ç»ªèŠ‚ç‚¹æ•°</th><td><span class="status-badge success">${overview.ready_nodes || 0}</span></td></tr>`;
        html += `<tr><th>æ€» Pod æ•°</th><td><span class="status-badge info">${overview.total_pods || 0}</span></td></tr>`;
        html += `<tr><th>è¿è¡Œä¸­ Pod</th><td><span class="status-badge success">${overview.running_pods || 0}</span></td></tr>`;
        html += `<tr><th>Pending Pod</th><td><span class="status-badge ${overview.pending_pods > 0 ? 'warning' : 'success'}">${overview.pending_pods || 0}</span></td></tr>`;
        html += `<tr><th>å¹³å‡ CPU ä½¿ç”¨ç‡</th><td>${overview.avg_cpu_usage ? overview.avg_cpu_usage.toFixed(2) + '%' : 'N/A'}</td></tr>`;
        html += `<tr><th>å¹³å‡å†…å­˜ä½¿ç”¨ç‡</th><td>${overview.avg_memory_usage ? overview.avg_memory_usage.toFixed(2) + '%' : 'N/A'}</td></tr>`;
        html += '</table>';
        
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºèŠ‚ç‚¹åˆ—è¡¨
    function displayNodesList(nodes) {
        const container = document.getElementById('nodesList');
        
        if (!nodes || nodes.length === 0) {
            container.innerHTML = '<p>æœªæ‰¾åˆ°èŠ‚ç‚¹</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>èŠ‚ç‚¹åç§°</th><th>çŠ¶æ€</th><th>CPU</th><th>å†…å­˜</th><th>Pods</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead>';
        html += '<tbody>';
        
        nodes.forEach(node => {
            html += '<tr>';
            html += `<td>${node.name}</td>`;
            html += `<td><span class="status-badge ${getStatusClass(node.status)}">${node.status}</span></td>`;
            html += `<td>${node.cpu_capacity || 'N/A'}</td>`;
            html += `<td>${node.memory_capacity || 'N/A'}</td>`;
            html += `<td>${node.pod_count || 0} / ${node.pod_capacity || 'N/A'}</td>`;
            html += `<td>${formatTimestamp(node.created_at)}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤º Pod åˆ†å¸ƒ
    function displayPodDistribution(distribution) {
        const container = document.getElementById('podDistribution');
        
        if (!distribution || Object.keys(distribution).length === 0) {
            container.innerHTML = '<p>æ—  Pod åˆ†å¸ƒæ•°æ®</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>èŠ‚ç‚¹</th><th>Pod æ•°é‡</th><th>Pod åˆ—è¡¨</th></tr></thead>';
        html += '<tbody>';
        
        for (const [nodeName, pods] of Object.entries(distribution)) {
            html += '<tr>';
            html += `<td>${nodeName}</td>`;
            html += `<td><span class="status-badge info">${pods.length}</span></td>`;
            html += `<td>${pods.map(p => p.name).join(', ')}</td>`;
            html += '</tr>';
        }
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤º Pending Pods
    function displayPendingPods(pendingPods) {
        const container = document.getElementById('pendingPods');
        
        if (!pendingPods || pendingPods.length === 0) {
            container.innerHTML = '<p class="status-badge success">âœ… æ²¡æœ‰ Pending çŠ¶æ€çš„ Pod</p>';
            return;
        }
        
        let html = '<div class="status-badge warning" style="display: block; margin-bottom: 10px;">âš ï¸ æ£€æµ‹åˆ° ' + pendingPods.length + ' ä¸ª Pending Podï¼Œå¯èƒ½è§¦å‘èŠ‚ç‚¹æ‰©å±•</div>';
        html += '<table class="table">';
        html += '<thead><tr><th>Pod åç§°</th><th>åŸå› </th><th>æ¶ˆæ¯</th><th>ç­‰å¾…æ—¶é—´</th></tr></thead>';
        html += '<tbody>';
        
        pendingPods.forEach(pod => {
            html += '<tr>';
            html += `<td>${pod.name}</td>`;
            html += `<td><span class="status-badge warning">${pod.reason || 'N/A'}</span></td>`;
            html += `<td>${pod.message || 'N/A'}</td>`;
            html += `<td>${pod.waiting_time || 'N/A'}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤º HPA çŠ¶æ€
    function displayHPAStatus(hpaStatus) {
        const container = document.getElementById('hpaStatus');
        
        if (!hpaStatus || hpaStatus.length === 0) {
            container.innerHTML = '<p>æœªæ‰¾åˆ° HPA é…ç½®</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>åç§°</th><th>å½“å‰å‰¯æœ¬</th><th>æœŸæœ›å‰¯æœ¬</th><th>æœ€å°/æœ€å¤§</th><th>CPU ä½¿ç”¨ç‡</th><th>ç›®æ ‡ CPU</th></tr></thead>';
        html += '<tbody>';
        
        hpaStatus.forEach(hpa => {
            const cpuClass = hpa.current_cpu_utilization > hpa.target_cpu_utilization ? 'error' : 'success';
            html += '<tr>';
            html += `<td>${hpa.name}</td>`;
            html += `<td><span class="status-badge info">${hpa.current_replicas || 0}</span></td>`;
            html += `<td><span class="status-badge success">${hpa.desired_replicas || 0}</span></td>`;
            html += `<td>${hpa.min_replicas || 0} / ${hpa.max_replicas || 0}</td>`;
            html += `<td><span class="status-badge ${cpuClass}">${hpa.current_cpu_utilization || 0}%</span></td>`;
            html += `<td>${hpa.target_cpu_utilization || 0}%</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºæ‰©å±•å†å²
    function displayScalingHistory(events) {
        const container = document.getElementById('scalingHistory');
        
        if (!events || events.length === 0) {
            container.innerHTML = '<p>æš‚æ— æ‰©å±•äº‹ä»¶</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>æ—¶é—´</th><th>ç±»å‹</th><th>è§¦å‘åŸå› </th><th>å˜åŒ–</th><th>çŠ¶æ€</th></tr></thead>';
        html += '<tbody>';
        
        events.forEach(event => {
            html += '<tr>';
            html += `<td>${formatTimestamp(event.timestamp)}</td>`;
            html += `<td><span class="status-badge info">${event.event_type || 'N/A'}</span></td>`;
            html += `<td>${event.trigger || 'N/A'}</td>`;
            
            if (event.details) {
                html += `<td>${event.details.replicas_before || 0} â†’ ${event.details.replicas_after || 0}</td>`;
            } else {
                html += `<td>N/A</td>`;
            }
            
            html += `<td><span class="status-badge ${getStatusClass(event.status || 'unknown')}">${event.status || 'N/A'}</span></td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', () => {
        loadAllScalingInfo();
        
        // æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadAllScalingInfo, 10000);
    });
</script>
{% endblock %}
