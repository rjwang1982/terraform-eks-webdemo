{% extends "base.html" %}

{% block title %}å­˜å‚¨æ¦‚è§ˆ - EKS Info WebApp{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ’¾ å­˜å‚¨ç³»ç»Ÿæ¦‚è§ˆ</h1>
    <p>æŸ¥çœ‹åº”ç”¨ä½¿ç”¨çš„æ‰€æœ‰å­˜å‚¨ç³»ç»Ÿ</p>
</div>

<div class="content">
    <!-- å­˜å‚¨æ‘˜è¦ -->
    <div class="card">
        <div class="card-header">ğŸ“Š å­˜å‚¨æ‘˜è¦</div>
        <div class="card-body" id="storageSummary">
            <!-- æ‘˜è¦ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- æŒ‚è½½ç‚¹ä¿¡æ¯ -->
    <div class="card">
        <div class="card-header">ğŸ“‚ æŒ‚è½½ç‚¹ä¿¡æ¯</div>
        <div class="card-body" id="mountPoints">
            <!-- æŒ‚è½½ç‚¹ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- å­˜å‚¨è¯¦æƒ… -->
    <div class="card">
        <div class="card-header">ğŸ” å­˜å‚¨è¯¦æƒ…</div>
        <div class="card-body" id="storageDetails">
            <!-- å­˜å‚¨è¯¦æƒ…å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
    
    <!-- å¯¼èˆªé“¾æ¥ -->
    <div class="card">
        <div class="card-header">ğŸ”— å­˜å‚¨æ¼”ç¤º</div>
        <div class="card-body" id="storageNavigation">
            <!-- å¯¼èˆªé“¾æ¥å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ä½œè€…: RJ.Wang
    // é‚®ç®±: wangrenjun@gmail.com
    // åˆ›å»ºæ—¶é—´: 2025-11-14
    
    // åŠ è½½å­˜å‚¨ä¿¡æ¯
    async function loadStorageInfo() {
        try {
            const data = await apiRequest('/storage/');
            displayStorageInfo(data);
        } catch (error) {
            console.error('åŠ è½½å­˜å‚¨ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºå­˜å‚¨ä¿¡æ¯
    function displayStorageInfo(data) {
        // æ˜¾ç¤ºæ‘˜è¦
        if (data.summary) {
            displaySummary(data.summary);
        }
        
        // æ˜¾ç¤ºæŒ‚è½½ç‚¹
        if (data.mount_points) {
            displayMountPoints(data.mount_points);
        }
        
        // æ˜¾ç¤ºå­˜å‚¨è¯¦æƒ…
        if (data.storage_details) {
            displayStorageDetails(data.storage_details);
        }
        
        // æ˜¾ç¤ºå¯¼èˆª
        if (data.navigation) {
            displayNavigation(data.navigation);
        }
    }
    
    // æ˜¾ç¤ºæ‘˜è¦
    function displaySummary(summary) {
        const container = document.getElementById('storageSummary');
        let html = '<table class="table">';
        html += `<tr><th>å¯ç”¨å­˜å‚¨ç³»ç»Ÿ</th><td>${summary.available_storage_count || 0} / ${summary.total_storage_count || 3}</td></tr>`;
        html += `<tr><th>æ€»æŒ‚è½½ç‚¹</th><td>${summary.total_mount_points || 0}</td></tr>`;
        html += '</table>';
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºæŒ‚è½½ç‚¹
    function displayMountPoints(mountPoints) {
        const container = document.getElementById('mountPoints');
        
        if (!mountPoints || mountPoints.length === 0) {
            container.innerHTML = '<p>æœªæ‰¾åˆ°æŒ‚è½½ç‚¹</p>';
            return;
        }
        
        let html = '<table class="table">';
        html += '<thead><tr><th>æŒ‚è½½è·¯å¾„</th><th>æ–‡ä»¶ç³»ç»Ÿ</th><th>å®¹é‡</th><th>å·²ç”¨</th><th>å¯ç”¨</th><th>ä½¿ç”¨ç‡</th></tr></thead>';
        html += '<tbody>';
        
        mountPoints.forEach(mount => {
            const usagePercent = mount.usage_percent || 0;
            const statusClass = usagePercent > 80 ? 'error' : usagePercent > 60 ? 'warning' : 'success';
            
            html += '<tr>';
            html += `<td>${mount.mount_point}</td>`;
            html += `<td>${mount.filesystem_type}</td>`;
            html += `<td>${formatBytes(mount.total_bytes)}</td>`;
            html += `<td>${formatBytes(mount.used_bytes)}</td>`;
            html += `<td>${formatBytes(mount.available_bytes)}</td>`;
            html += `<td><span class="status-badge ${statusClass}">${formatPercent(usagePercent)}</span></td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºå­˜å‚¨è¯¦æƒ…
    function displayStorageDetails(details) {
        const container = document.getElementById('storageDetails');
        let html = '';
        
        // EBS è¯¦æƒ…
        if (details.ebs) {
            html += '<h3>EBS (Elastic Block Store)</h3>';
            html += '<table class="table">';
            html += `<tr><th>çŠ¶æ€</th><td><span class="status-badge ${details.ebs.available ? 'success' : 'error'}">${details.ebs.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}</span></td></tr>`;
            html += `<tr><th>æŒ‚è½½è·¯å¾„</th><td>${details.ebs.mount_path || 'N/A'}</td></tr>`;
            html += `<tr><th>è®¿é—®æ¨¡å¼</th><td>ReadWriteOnce</td></tr>`;
            if (details.ebs.error) {
                html += `<tr><th>é”™è¯¯</th><td class="status-badge error">${details.ebs.error}</td></tr>`;
            }
            html += '</table>';
        }
        
        // EFS è¯¦æƒ…
        if (details.efs) {
            html += '<h3>EFS (Elastic File System)</h3>';
            html += '<table class="table">';
            html += `<tr><th>çŠ¶æ€</th><td><span class="status-badge ${details.efs.available ? 'success' : 'error'}">${details.efs.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}</span></td></tr>`;
            html += `<tr><th>æŒ‚è½½è·¯å¾„</th><td>${details.efs.mount_path || 'N/A'}</td></tr>`;
            html += `<tr><th>è®¿é—®æ¨¡å¼</th><td>ReadWriteMany</td></tr>`;
            if (details.efs.error) {
                html += `<tr><th>é”™è¯¯</th><td class="status-badge error">${details.efs.error}</td></tr>`;
            }
            html += '</table>';
        }
        
        // S3 è¯¦æƒ…
        if (details.s3) {
            html += '<h3>S3 (Simple Storage Service)</h3>';
            html += '<table class="table">';
            html += `<tr><th>çŠ¶æ€</th><td><span class="status-badge ${details.s3.available ? 'success' : 'error'}">${details.s3.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}</span></td></tr>`;
            html += `<tr><th>å­˜å‚¨æ¡¶</th><td>${details.s3.bucket_name || 'N/A'}</td></tr>`;
            html += `<tr><th>åŒºåŸŸ</th><td>${details.s3.region || 'N/A'}</td></tr>`;
            html += `<tr><th>è®¿é—®æ–¹å¼</th><td>IRSA (IAM Roles for Service Accounts)</td></tr>`;
            if (details.s3.error) {
                html += `<tr><th>é”™è¯¯</th><td class="status-badge error">${details.s3.error}</td></tr>`;
            }
            html += '</table>';
        }
        
        container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºå¯¼èˆª
    function displayNavigation(navigation) {
        const container = document.getElementById('storageNavigation');
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
        
        if (navigation.ebs_available) {
            html += `
                <a href="${navigation.ebs_demo}" class="btn btn-primary" style="text-align: center;">
                    ğŸ“¦ EBS æ¼”ç¤º
                </a>
            `;
        }
        
        if (navigation.efs_available) {
            html += `
                <a href="${navigation.efs_demo}" class="btn btn-primary" style="text-align: center;">
                    ğŸ“ EFS æ¼”ç¤º
                </a>
            `;
        }
        
        if (navigation.s3_available) {
            html += `
                <a href="${navigation.s3_demo}" class="btn btn-primary" style="text-align: center;">
                    â˜ï¸ S3 æ¼”ç¤º
                </a>
            `;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', loadStorageInfo);
</script>
{% endblock %}
