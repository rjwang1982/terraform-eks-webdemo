# EKS + Web åº”ç”¨ä¸€ä½“åŒ–éƒ¨ç½²

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Amazon EKS é›†ç¾¤å’Œ Web åº”ç”¨çš„è‡ªåŠ¨åŒ–éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ Terraform è¿›è¡ŒåŸºç¡€è®¾æ–½å³ä»£ç ç®¡ç†ã€‚

## ä½œè€…ä¿¡æ¯

- **ä½œè€…**: RJ.Wang
- **é‚®ç®±**: wangrenjun@gmail.com
- **é¡¹ç›®**: EKS é›†ç¾¤ + Python Web åº”ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **ä¸€é”®éƒ¨ç½²**: è‡ªåŠ¨åˆ›å»º EKS é›†ç¾¤ã€VPCã€åº”ç”¨ç­‰æ‰€æœ‰èµ„æº
- ğŸ§¹ **ä¸€é”®æ¸…ç†**: è‡ªåŠ¨åˆ é™¤æ‰€æœ‰åˆ›å»ºçš„ AWS èµ„æºï¼Œé¿å…äº§ç”Ÿä¸å¿…è¦è´¹ç”¨
- ğŸ“Š **è¿›åº¦ç›‘æ§**: å®æ—¶æ˜¾ç¤ºéƒ¨ç½²è¿›åº¦å’ŒçŠ¶æ€
- ğŸ’° **æˆæœ¬é€æ˜**: æ¸…æ™°æ˜¾ç¤ºé¢„ä¼°æˆæœ¬å’Œèµ„æºä½¿ç”¨æƒ…å†µ
- ğŸ”§ **å·¥å…·æ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥æ‰€éœ€å·¥å…·å’Œ AWS å‡­è¯
- ğŸ“‹ **è¯¦ç»†è¾“å‡º**: æä¾›è¯¦ç»†çš„éƒ¨ç½²ä¿¡æ¯å’Œç®¡ç†å‘½ä»¤

## éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AWS VPC                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Public AZ-A   â”‚  â”‚   Public AZ-B   â”‚  â”‚ Public AZ-C  â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚   NAT Gateway   â”‚  â”‚   NAT Gateway   â”‚  â”‚ NAT Gateway  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Private AZ-A   â”‚  â”‚  Private AZ-B   â”‚  â”‚ Private AZ-C â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  EKS Nodes      â”‚  â”‚  EKS Nodes      â”‚  â”‚  EKS Nodes   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Application     â”‚
                    â”‚ Load Balancer   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Internet      â”‚
                    â”‚   Gateway       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éƒ¨ç½²çš„èµ„æº

### ç½‘ç»œåŸºç¡€è®¾æ–½
- **VPC**: 10.101.0.0/16 CIDR
- **å…¬æœ‰å­ç½‘**: 3ä¸ªå¯ç”¨åŒºï¼Œæ¯ä¸ª /24
- **ç§æœ‰å­ç½‘**: 6ä¸ªå­ç½‘ï¼ˆæ¯ä¸ªå¯ç”¨åŒº2ä¸ªï¼‰ï¼Œæ¯ä¸ª /24
- **NAT Gateway**: 3ä¸ªï¼ˆæ¯ä¸ªå¯ç”¨åŒº1ä¸ªï¼‰
- **Internet Gateway**: 1ä¸ª
- **è·¯ç”±è¡¨**: å…¬æœ‰å’Œç§æœ‰è·¯ç”±è¡¨

### EKS é›†ç¾¤
- **EKS é›†ç¾¤**: Kubernetes 1.31
- **èŠ‚ç‚¹ç»„**: t3.medium å®ä¾‹ï¼Œ2-4ä¸ªèŠ‚ç‚¹
- **IAM è§’è‰²**: é›†ç¾¤å’ŒèŠ‚ç‚¹ç»„æ‰€éœ€çš„è§’è‰²å’Œç­–ç•¥
- **å®‰å…¨ç»„**: é›†ç¾¤å’ŒèŠ‚ç‚¹çš„å®‰å…¨ç»„é…ç½®

### åº”ç”¨ç»„ä»¶
- **Namespace**: rj-webdemo
- **Deployment**: Python Web åº”ç”¨ï¼Œ3ä¸ªå‰¯æœ¬
- **Service**: NodePort æœåŠ¡
- **Ingress**: ALB Ingress Controller
- **Load Balancer**: Application Load Balancer

### æ”¯æŒç»„ä»¶
- **AWS Load Balancer Controller**: Helm éƒ¨ç½²
- **Service Account**: IRSA é…ç½®
- **IAM ç­–ç•¥**: Load Balancer Controller æƒé™

## å‰ç½®è¦æ±‚

### å¿…éœ€å·¥å…·
- [Terraform](https://www.terraform.io/downloads.html) >= 1.3.2
- [kubectl](https://kubernetes.io/docs/tasks/tools/) >= 1.28
- [Helm](https://helm.sh/docs/intro/install/) >= 3.0
- [AWS CLI](https://aws.amazon.com/cli/) >= 2.0

### AWS é…ç½®
```bash
# é…ç½® AWS å‡­è¯
aws configure

# æˆ–è®¾ç½®ç¯å¢ƒå˜é‡
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
export AWS_DEFAULT_REGION="ap-southeast-1"
```

### IAM æƒé™
ç¡®ä¿ AWS ç”¨æˆ·å…·æœ‰ä»¥ä¸‹æƒé™ï¼š
- EC2 å®Œå…¨è®¿é—®æƒé™
- EKS å®Œå…¨è®¿é—®æƒé™
- IAM è§’è‰²å’Œç­–ç•¥ç®¡ç†æƒé™
- VPC å’Œç½‘ç»œèµ„æºç®¡ç†æƒé™
- Application Load Balancer ç®¡ç†æƒé™

## ä½¿ç”¨æ–¹æ³•

### 1. éƒ¨ç½²é›†ç¾¤å’Œåº”ç”¨

```bash
# æ–¹æ³•1ï¼šç›´æ¥è¿è¡Œ
./deploy.sh

# æ–¹æ³•2ï¼šæ˜ç¡®æŒ‡å®šéƒ¨ç½²
./deploy.sh deploy
```

éƒ¨ç½²è¿‡ç¨‹åŒ…æ‹¬ï¼š
1. âœ… å·¥å…·å’Œå‡­è¯æ£€æŸ¥
2. ğŸ”§ Terraform åˆå§‹åŒ–
3. ğŸ“‹ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
4. âš ï¸ ç¡®è®¤éƒ¨ç½²ï¼ˆéœ€è¦è¾“å…¥ 'yes'ï¼‰
5. ğŸš€ åˆ›å»ºåŸºç¡€è®¾æ–½ï¼ˆ15-20åˆ†é’Ÿï¼‰
6. ğŸ”§ é…ç½® kubectl
7. â³ ç­‰å¾…åº”ç”¨å°±ç»ª
8. ğŸ“Š æ˜¾ç¤ºè®¿é—®ä¿¡æ¯

### 2. æ¸…ç†æ‰€æœ‰èµ„æº

```bash
./deploy.sh clean
```

æ¸…ç†è¿‡ç¨‹åŒ…æ‹¬ï¼š
1. âš ï¸ ç¡®è®¤åˆ é™¤ï¼ˆéœ€è¦è¾“å…¥ 'yes'ï¼‰
2. ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰ AWS èµ„æºï¼ˆ10-15åˆ†é’Ÿï¼‰
3. ğŸ§¹ æ¸…ç†æœ¬åœ°æ–‡ä»¶

### 3. æŸ¥çœ‹å¸®åŠ©

```bash
./deploy.sh help
```

## æˆæœ¬ä¼°ç®—

### ä¸»è¦è´¹ç”¨ç»„ä»¶
- **EKS é›†ç¾¤**: ~$0.10/å°æ—¶
- **EC2 å®ä¾‹**: t3.medium Ã— 2-4ä¸ª â‰ˆ $0.08-0.16/å°æ—¶
- **NAT Gateway**: 3ä¸ª Ã— $0.045/å°æ—¶ â‰ˆ $0.135/å°æ—¶
- **Application Load Balancer**: ~$0.025/å°æ—¶
- **æ•°æ®ä¼ è¾“**: æ ¹æ®ä½¿ç”¨é‡

**æ€»è®¡**: çº¦ $2-4/å°æ—¶ï¼ˆæ ¹æ®åŒºåŸŸå’Œä½¿ç”¨æƒ…å†µï¼‰

âš ï¸ **é‡è¦**: æµ‹è¯•å®Œæˆåè¯·åŠæ—¶è¿è¡Œ `./deploy.sh clean` æ¸…ç†èµ„æºï¼

## éƒ¨ç½²åç®¡ç†

### è®¿é—®åº”ç”¨
éƒ¨ç½²å®Œæˆåï¼Œè„šæœ¬ä¼šæ˜¾ç¤ºåº”ç”¨çš„è®¿é—®åœ°å€ï¼š
```
ğŸŒ åº”ç”¨è®¿é—®åœ°å€:
   http://your-alb-hostname.region.elb.amazonaws.com
```

### å¸¸ç”¨ kubectl å‘½ä»¤
```bash
# æŸ¥çœ‹ Pod çŠ¶æ€
kubectl get pods -n rj-webdemo

# æŸ¥çœ‹æœåŠ¡
kubectl get services -n rj-webdemo

# æŸ¥çœ‹ Ingress
kubectl get ingress -n rj-webdemo

# æ‰©ç¼©å®¹åº”ç”¨
kubectl scale deployment rj-py-webdemo --replicas=5 -n rj-webdemo

# æŸ¥çœ‹ Pod æ—¥å¿—
kubectl logs -f deployment/rj-py-webdemo -n rj-webdemo
```

### Terraform å‘½ä»¤
```bash
# æŸ¥çœ‹è¾“å‡ºä¿¡æ¯
terraform output

# æŸ¥çœ‹çŠ¶æ€
terraform state list

# æŸ¥çœ‹ç‰¹å®šèµ„æº
terraform show
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **éƒ¨ç½²å¤±è´¥**
   - æ£€æŸ¥ AWS é…é¢é™åˆ¶
   - ç¡®è®¤åŒºåŸŸæ”¯æŒ EKS æœåŠ¡
   - æ£€æŸ¥ IAM æƒé™
   - æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

2. **åº”ç”¨æ— æ³•è®¿é—®**
   - ç­‰å¾… ALB å®Œå…¨å°±ç»ªï¼ˆ2-3åˆ†é’Ÿï¼‰
   - æ£€æŸ¥å®‰å…¨ç»„é…ç½®
   - éªŒè¯ DNS è§£æ

3. **kubectl è¿æ¥å¤±è´¥**
   - é‡æ–°é…ç½® kubeconfigï¼š
     ```bash
     aws eks update-kubeconfig --region ap-southeast-1 --name RJtest-eks-cluster-20250822
     ```

4. **æ¸…ç†å¤±è´¥**
   - æ‰‹åŠ¨æ£€æŸ¥ AWS æ§åˆ¶å°
   - ç¡®è®¤æ²¡æœ‰å…¶ä»–ä¾èµ–èµ„æº
   - é‡æ–°è¿è¡Œæ¸…ç†å‘½ä»¤

### æ—¥å¿—æŸ¥çœ‹
```bash
# Terraform è¯¦ç»†æ—¥å¿—
export TF_LOG=DEBUG
terraform apply

# kubectl è¯¦ç»†è¾“å‡º
kubectl get events -n rj-webdemo
```

## æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ deploy.sh              # ä¸»éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ versions.tf            # Terraform ç‰ˆæœ¬çº¦æŸå’Œ Provider é…ç½®
â”œâ”€â”€ main.tf                # åŸºç¡€è®¾æ–½å®šä¹‰
â”œâ”€â”€ app.tf                 # åº”ç”¨èµ„æºå®šä¹‰
â”œâ”€â”€ variables.tf           # å˜é‡å®šä¹‰
â”œâ”€â”€ outputs.tf             # è¾“å‡ºå®šä¹‰
â”œâ”€â”€ terraform.tfvars       # å˜é‡å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
â”œâ”€â”€ README.md              # æœ¬æ–‡æ¡£
â”œâ”€â”€ .gitignore             # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ .terraform/            # Terraform å·¥ä½œç›®å½•
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **å‡­è¯ç®¡ç†**: ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  AWS å‡­è¯
2. **ç½‘ç»œå®‰å…¨**: ç§æœ‰å­ç½‘ä¸­çš„èŠ‚ç‚¹é€šè¿‡ NAT Gateway è®¿é—®äº’è”ç½‘
3. **IAM æƒé™**: ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
4. **èµ„æºæ ‡ç­¾**: æ‰€æœ‰èµ„æºéƒ½æœ‰é€‚å½“çš„æ ‡ç­¾ç”¨äºç®¡ç†å’Œè®¡è´¹

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œæµ‹è¯•ä½¿ç”¨ã€‚è¯·éµå®ˆ AWS æœåŠ¡æ¡æ¬¾å’Œç›¸å…³æ³•å¾‹æ³•è§„ã€‚

---

**âš ï¸ é‡è¦æé†’**: è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºé¡¹ç›®ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†çš„å®‰å…¨è¯„ä¼°å’Œé…ç½®è°ƒæ•´ã€‚
